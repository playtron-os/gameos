# Playtron OS Taskfile
# https://taskfile.dev

version: "3"

env:
  IMAGE: playtronos

tasks:
  rpm-repo:
    desc: Build a local rpm-ostree repository with local RPMs.
    dir: rpm-ostree
    cmds:
      - mkdir -p /tmp/repo || true
      - echo "Checking if any RPMs exist in the /tmp/repo/ directory..."
      - ls /tmp/repo | grep rpm || exit 1
      - createrepo /tmp/repo
      - grep "  - local" playtron-os.yaml || sed -i s'/repos:/repos:\n  - local'/g playtron-os.yaml
      - echo -e "[local]\nname=local\nbaseurl=file:///tmp/repo\nenabled=1\nrepo_gpgcheck=0\ngpgcheck=0" > local.repo


  container-image:auth:
    desc: Authenticate with the container registry.
    preconditions:
      - sh: test -n "$REGISTRY"
        msg: "A value for REGISTRY must be provided"
      - sh: test -n "$REGISTRY_TOKEN"
        msg: "A value for REGISTRY_TOKEN must be provided"
    cmds:
      - mkdir -p ${XDG_RUNTIME_DIR}/containers
      - echo "{ \"auths\":{ \"${REGISTRY}\":{ \"auth\":\"${REGISTRY_TOKEN}\" } } }" > "${XDG_RUNTIME_DIR}/containers/auth.json"

  container-image:build:
    desc: Build the OCI container image.
    dir: rpm-ostree
    preconditions:
      - sh: test -n "$TAG"
        msg: "A value for TAG must be provided"
    cmds:
      - mkdir -p rootfs/usr/lib
      - cat os-release.template | envsubst '${TAG}' > rootfs/usr/lib/os-release
      - podman build . --pull --no-cache --tag ${IMAGE}:${TAG}

  container-image:push:
    desc: Push the OCI container image to the container registry.
    preconditions:
      - sh: grep "${REGISTRY}" "${XDG_RUNTIME_DIR}/containers/auth.json"
        msg: "Please use `container-image:auth` to authenticate with the registry"
      - sh: test -n "$TAG"
        msg: "A value for TAG must be provided"
      - sh: test -n "$REGISTRY"
        msg: "A value for REGISTRY must be provided"
      - sh: test -n "$PROJECT"
        msg: "A value for PROJECT must be provided"
    cmds:
      - podman push ${IMAGE}:${TAG} ${REGISTRY}/${PROJECT}/${IMAGE}:${TAG}

  container-image:release:
    desc: Release the OCI container image by tagging it as `latest` in the container registry.
    preconditions:
      - sh: grep "${REGISTRY}" "${XDG_RUNTIME_DIR}/containers/auth.json"
        msg: "Please use `container-image:auth` to authenticate with the registry"
      - sh: test -n "$TAG"
        msg: "A value for TAG must be provided"
      - sh: test -n "$REGISTRY"
        msg: "A value for REGISTRY must be provided"
      - sh: test -n "$PROJECT"
        msg: "A value for PROJECT must be provided"
    cmds:
      - podman tag ${IMAGE}:${TAG} ${IMAGE}:latest
      - podman push ${IMAGE}:latest ${REGISTRY}/${PROJECT}/${IMAGE}:latest

  disk-image:
    desc: Build the OS image from a container hosted in a registry.
    dir: kickstart
    env:
      TAG: latest
    preconditions:
      - sh: test "$EUID" == 0
        msg: "This task must be run as root"
      - sh: test -n "$REGISTRY"
        msg: "A value for REGISTRY must be provided"
      - sh: test -n "$REGISTRY_TOKEN"
        msg: "A value for REGISTRY_TOKEN must be provided"
      - sh: test -n "$PROJECT"
        msg: "A value for PROJECT must be provided"
    cmds:
      - cat playtron-os_kickstart.cfg.template | envsubst '${REGISTRY} ${REGISTRY_TOKEN} ${PROJECT} ${TAG}' > playtron-os_kickstart.cfg
      - ./virt-install.sh
      - mv /var/lib/libvirt/images/playtron-os.img "/var/lib/libvirt/images/playtron-os.img_$(date -Iseconds)"
      - virsh undefine --nvram playtron-os

  repo:update:
    desc: "Update the package repository"
    cmds:
      - rm -rf /tmp/repo
      - mkdir -p /tmp/repo
      - aws s3 cp s3://playtron-dev2-global-os-public/repos/playtron-app/x86_64/ /tmp/repo/ --recursive
      - read -p "Copy new packages into /tmp/repo and press ENTER to continue"
      - createrepo /tmp/repo
      - aws s3 sync /tmp/repo/ s3://playtron-dev2-global-os-public/repos/playtron-app/x86_64/
