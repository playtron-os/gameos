FROM registry.playtron.one/internal/playtronos:0.19.0.19

# Set OS version
COPY rootfs/usr/lib/os-release-playtron /usr/lib/

# https://github.com/playtron-os/rpm-specs-gaming
RUN dnf5 -y upgrade \
  gamescope-session-playtron \
  gamescope-session \
  legendary \
  mangohud \
  inputplumber \
  grid \
  playserve \
  playtron-os-files \
  reaper \
  tzupdate \
  udev-media-automount \
  valve-firmware \
  && ostree container commit

# Temporarily upgrade NVIDIA while the 560 driver is broken.
RUN dnf5 -y upgrade \
  *nvidia* \
  && mkdir -p /run/akmods; for k in $(ls -1 /usr/src/kernels); do \
  akmods --force --kernels "${k}" --kmod "nvidia" || exit 1; done; rm -r -f /run/akmods \
  && ostree container commit

# Temporarily remove zram packages until we update our stable base image.
RUN dnf5 -y remove \
  zram-generator \
  zram-generator-defaults

# Temporarily add the "resume" Dracut module until we update our stable base image.
RUN KERNEL=$(echo /lib/modules/*/initramfs.img | cut -d'/' -f4) \
  && dracut --reproducible -v --omit-drivers nouveau --add 'ostree resume' -f --no-hostonly --kver ${KERNEL} /lib/modules/${KERNEL}/initramfs.img \
  && ostree container commit

# View final packages.
RUN rpm -qa | sort
